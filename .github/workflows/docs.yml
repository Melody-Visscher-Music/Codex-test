name: Docs
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install Poetry
        run: curl -sSL https://install.python-poetry.org | python3 -
      - name: Set PATH
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH
      - name: Install dependencies
        run: poetry install --no-interaction --no-ansi
      - name: Update README CLI help
        run: |
          python - <<'PY'
import pathlib, re, subprocess
help_text = subprocess.check_output(["poetry", "run", "python", "-m", "blender_tools.cli", "--help"]).decode()
readme = pathlib.Path("README.md").read_text()
pattern = re.compile(r"(<!-- CLI_HELP_START -->)(.*?)(<!-- CLI_HELP_END -->)", re.S)
new = pattern.sub(r"\1\n```\n" + help_text + "```\n\3", readme)
pathlib.Path("README.md").write_text(new)
PY
      - name: Commit
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add README.md
          git commit -m "docs: update CLI help" || echo "no changes"
          git push
